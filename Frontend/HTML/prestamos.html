<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Préstamos - Biblioteca</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Estilos personalizados -->
  <link rel="stylesheet" href="../CSS/prestamos.css">
  <link rel="stylesheet" href="../CSS/variables.css">
</head>

<body class="d-flex">

  <!-- Sidebar  -->
  <div class="sidebar d-flex flex-column flex-shrink-0 bg-dark text-white" style="width: 260px; min-height: 100vh; position: fixed; top: 0; left: 0; z-index: 1000;">
    <div class="sidebar-header p-4 text-center border-bottom border-secondary">
      <h4 class="mb-0 fw-bold">Gestión administrativa</h4>
    </div>
    <ul class="nav nav-pills flex-column mb-auto px-3 py-4">
      <li class="nav-item mb-2">
        <a href="/dashboard" class="nav-link text-white d-flex align-items-center py-3 px-3">
          <i class="bi bi-house-door fs-5 me-3"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="/libros" class="nav-link text-white d-flex align-items-center py-3 px-3">
          <i class="bi bi-book fs-5 me-3"></i>
          <span>Libros</span>
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="/miembros" class="nav-link text-white d-flex align-items-center py-3 px-3">
          <i class="bi bi-people fs-5 me-3"></i>
          <span>Miembros</span>
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="/prestamos" class="nav-link text-white active d-flex align-items-center py-3 px-3" aria-current="page">
          <i class="bi bi-journal-check fs-5 me-3"></i>
          <span>Préstamos</span>
        </a>
      </li>
      <li class="nav-item mb-2">
        <a href="/perfil" class="nav-link text-white d-flex align-items-center py-3 px-3">
          <i class="bi bi-person-circle fs-5 me-3"></i>
          <span>Perfil</span>
        </a>
      </li>
    </ul>
    <div class="mt-auto p-3 border-top border-secondary">
      <button id="logoutButton" class="nav-link btn btn-link text-danger fw-bold w-100 text-start d-flex align-items-center py-3 px-3">
        <i class="bi bi-box-arrow-right fs-5 me-3"></i>
        <span>Salir</span>
      </button>
    </div>
  </div>

  <!-- Contenedor principal ajustado con margin-left para el sidebar fijo -->
  <div class="flex-grow-1 d-flex flex-column" style="margin-left: 260px;">
    
    <!-- Navbar único con búsqueda, filtros y botones -->
    <nav class="navbar-custom px-4 py-3">
      <div class="row w-100 align-items-end g-3">
        <!-- Campo de búsqueda -->
        <div class="col-12 col-md-3">
          <label class="navbar-label">Buscar prestamo</label>
          <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" id="buscadorPrestamo" placeholder="Miembro, libro, ID..." class="form-control">
          </div>
        </div>

        <!-- Filtro de Estado -->
        <div class="col-6 col-md-2">
          <label class="navbar-label">Estado</label>
          <select class="filter-dropdown form-select" id="filtroEstado">
            <option value="">Todos</option>
            <option value="Activo">Activos</option>
            <option value="Vencido">Vencidos</option>
            <option value="Devuelto">Devueltos</option>
          </select>
        </div>

        <!-- Filtro de Fecha -->
        <div class="col-6 col-md-2">
          <label class="navbar-label">Periodo</label>
          <select class="filter-dropdown form-select" id="filtroPeriodo">
            <option value="todos">Todos</option>
            <option value="hoy">Hoy</option>
            <option value="semana">Última semana</option>
            <option value="mes">Último mes</option>
          </select>
        </div>

        <!-- Botones de acción -->
        <div class="col-12 col-md-5 text-md-end">
          <button class="btn btn-nuevo-prestamo me-2" data-bs-toggle="modal" data-bs-target="#modalNuevoPrestamo">
            <i class="bi bi-plus-circle me-2"></i>Nuevo Prestamo
          </button>
          <button class="btn btn-beneficios" data-bs-toggle="modal" data-bs-target="#modalBeneficios">
            <i class="bi bi-gift me-2"></i>Beneficios
          </button>
        </div>

        <!-- Rango personalizado (oculto por defecto) -->
        <div class="col-12" id="rangoPersonalizado" style="display: none;">
          <label class="navbar-label">Desde - Hasta</label>
          <div class="d-flex gap-2">
            <input type="date" class="form-control form-control-sm" id="fechaDesde">
            <input type="date" class="form-control form-control-sm" id="fechaHasta">
          </div>
        </div>
      </div>
    </nav>

    <!-- Contadores de estadísticas -->
    <div class="px-4 py-3">
      <div class="row g-3">
        <div class="col-12 col-md-4">
          <div class="stats-card stats-prestados">
            <div class="stats-icon">
              <i class="bi bi-book-half"></i>
            </div>
            <div class="stats-info">
              <h3 class="stats-number" id="totalPrestados">#</h3>
              <p class="stats-label">Libros Prestados</p>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="stats-card stats-vencidos">
            <div class="stats-icon">
              <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="stats-info">
              <h3 class="stats-number" id="totalVencidos">3</h3>
              <p class="stats-label">Prestamos Vencidos</p>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="stats-card stats-devueltos">
            <div class="stats-icon">
              <i class="bi bi-check-circle"></i>
            </div>
            <div class="stats-info">
              <h3 class="stats-number" id="totalDevueltos">3</h3>
              <p class="stats-label">Devueltos </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de préstamos -->
    <div class="px-4 pb-4 flex-grow-1">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID PRESTAMO</th>
              <th>MIEMBRO</th>
              <th>LIBRO</th>
              <th>FECHA PRESTAMO</th>
              <th>FECHA DEVOLUCION</th>
              <th>ESTADO</th>
              <th>DIAS RESTANTES</th>
              <th>ACCIONES</th>
            </tr>
          </thead>
          <tbody id="tablaPrestamos">
            <!-- Datos de ejemplo -->
          
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Préstamo -->
  <div class="modal fade" id="modalNuevoPrestamo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Registrar Nuevo Préstamo</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formNuevoPrestamo">
            <div class="mb-3 position-relative">
              <label class="form-label">Miembro <span class="text-danger">*</span></label>
              <input 
                type="text" 
                class="form-control" 
                id="miembroPrestamo" 
                placeholder="Escribe el nombre del miembro..." 
                autocomplete="off"
                required>
              <ul id="listaMiembros" class="list-group position-absolute w-100 mt-1" style="z-index:1050; display:none; max-height: 200px; overflow-y: auto;"></ul>
              <small class="text-muted">Selecciona un miembro de la lista de sugerencias</small>
            </div>
            <div class="mb-3 position-relative">
              <label class="form-label">Libro <span class="text-danger">*</span></label>
              <input 
                type="text" 
                class="form-control" 
                id="libroPrestamo" 
                placeholder="Escribe el título del libro..." 
                autocomplete="off"
                required>
              <ul id="listaLibros" class="list-group position-absolute w-100 mt-1" style="z-index:1050; display:none; max-height: 200px; overflow-y: auto;"></ul>
              <small class="text-muted d-block">Selecciona un libro de la lista de sugerencias</small>
              <div id="libroCantidadDisponible" class="small text-muted mt-1" style="display:none;">Disponibles: -</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Fecha de Préstamo</label>
              <input type="date" class="form-control" id="fechaPrestamo" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Fecha de Devolución</label>
              <input type="date" class="form-control" id="fechaDevolucion" required>
            </div>
            <button type="submit" class="btn btn-success w-100">Registrar Préstamo</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar Préstamo -->
  <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">Editar Prestamo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formEditarPrestamo">
            <div class="mb-3">
              <label class="form-label">ID Prestamo</label>
              <input type="text" class="form-control" value="#P001" disabled>
            </div>
            <div class="mb-3">
              <label class="form-label">Miembro</label>
              <input type="text" class="form-control" value="Juan Pérez" disabled>
            </div>
            <div class="mb-3">
              <label class="form-label">Libro</label>
              <input type="text" class="form-control" value="Cien años de soledad" disabled>
            </div>
            <div class="mb-3">
              <label class="form-label">Nueva Fecha de Devolucion</label>
              <input type="date" class="form-control" id="nuevaFechaDevolucion" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Observaciones</label>
              <textarea class="form-control" rows="3" id="observaciones"></textarea>
            </div>
            <button type="submit" class="btn btn-warning w-100">Actualizar Prestamo</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Registrar Devolución -->
  <div class="modal fade" id="modalDevolucion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Registrar Devolucion</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <strong>Prestamo:</strong> #P001<br>
            <strong>Miembro:</strong> Juan Pérez<br>
            <strong>Libro:</strong> Cien años de soledad
          </div>
          <form id="formDevolucion">
            <div class="mb-3">
              <label class="form-label">Fecha de Devolucion Real</label>
              <input type="date" class="form-control" id="fechaDevolucionReal" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Estado del Libro</label>
              <select class="form-select" id="estadoLibro" required>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo (con daños)</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Notas Adicionales</label>
              <textarea class="form-control" rows="3" id="notasDevolucion"></textarea>
            </div>
            <button type="submit" class="btn btn-success w-100">Confirmar Devolucion</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Enviar Recordatorio -->
  <div class="modal fade" id="modalRecordatorio" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Enviar Recordatorio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-secondary">
            <strong>Para:</strong> Juan Pérez (juan.perez@email.com)<br>
            <strong>Préstamo:</strong> #P001 - Cien años de soledad
          </div>
          <form id="formRecordatorio">
            <div class="mb-3">
              <label class="form-label">Asunto</label>
              <input type="text" class="form-control" id="asuntoRecordatorio" value="Recordatorio de Devolución de Libro" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Mensaje</label>
              <textarea class="form-control" rows="5" id="mensajeRecordatorio">Estimado/a Juan Pérez,

Le recordamos que el libro "Cien años de soledad" debe ser devuelto el 29/12/2024.

Gracias por su colaboración.</textarea>
            </div>
          <!-- NUEVAS CASILLAS DE CHECK EN LÍNEA -->
<div class="mb-3">
  <label class="form-label">Enviar Notificación vía:</label>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" value="email" id="checkEmail" checked>
    <label class="form-check-label" for="checkEmail">Email</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" value="whatsapp" id="checkWhatsapp">
    <label class="form-check-label" for="checkWhatsapp">WhatsApp</label>
  </div>
</div>

            <button type="submit" class="btn btn-info w-100 text-white">
              <i class="bi bi-envelope me-2"></i>Enviar Recordatorio
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

 <!-- Modal Enviar Multa -->
<div class="modal fade" id="modalMulta" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Notificación de Multa por Mora</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <strong>Para:</strong> María González (maria.gonzalez@email.com)<br>
          <strong>Préstamo:</strong> #P002 - El Principito<br>
          <strong>Días de retraso:</strong> 0 días
        </div>
        <form id="formMulta">
          <div class="mb-3">
            <label class="form-label">Monto de la Multa ($)</label>
            <input type="number" class="form-control" id="montoMulta" value="5.00" step="0.01" readonly>
            <!-- <small class="text-muted">$1.00 por día de retraso</small> -->
          </div>

          <div class="mb-3">
            <label class="form-label">Asunto</label>
            <input type="text" class="form-control" id="asuntoMulta" value="Notificación de Multa por Retraso" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Mensaje</label>
            <textarea class="form-control" rows="6" id="mensajeMulta">Estimado/a María González,

Le informamos que el libro "El Principito" fue devuelto con 0 días de retraso.

Se ha generado una multa de $5.00 por el retraso en la devolución.

Por favor, realice el pago a la brevedad posible.

Gracias.</textarea>
          </div>

          <!-- NUEVAS CASILLAS DE CHECK -->
<div class="mb-3">
  <label class="form-label">Enviar Notificación vía:</label>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" value="email" id="checkEmail" checked>
    <label class="form-check-label" for="checkEmail">Email</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" value="whatsapp" id="checkWhatsapp">
    <label class="form-check-label" for="checkWhatsapp">WhatsApp</label>
  </div>
</div>


          <button type="submit" class="btn btn-danger w-100">
            <i class="bi bi-currency-dollar me-2"></i>Enviar Notificación de Multa
          </button>
        </form>
      </div>
    </div>
  </div>
</div>


  <!-- Modal Beneficios -->
  <div class="modal fade" id="modalBeneficios" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-gradient">
          <h5 class="modal-title text-dark">
            <i class="bi bi-gift me-2"></i>Programa de Beneficios
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <label class="form-label fw-bold">Filtrar miembros por mínimo de préstamos en los últimos días</label>
            <div class="row g-2 align-items-center">
              <div class="col-6">
                <input type="number" class="form-control" id="minimoPrestamos" value="4" min="0" placeholder="Min. préstamos">
              </div>
              <div class="col-3">
                <input type="number" class="form-control" id="diasPeriodo" value="30" min="1" placeholder="Días (p. ej. 30)">
              </div>
              <div class="col-3">
                <input type="number" class="form-control" id="minDiasPorPrestamo" value="7" min="1" placeholder="Min días por préstamo">
              </div>
              <div class="col-2 d-grid">
                <button class="btn btn-primary" id="btnFiltrarBeneficios">
                  <i class="bi bi-funnel me-2"></i>Filtrar
                </button>
              </div>
            </div>
            <small class="text-muted">Muestra miembros con al menos N préstamos en los últimos X días</small>
          </div>

          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Mostrando miembros con <strong id="cantidadFiltrada">4</strong> prestamos en los últimos <strong id="diasFiltrados">30</strong> días cada prestamo devuelto en <strong id="minDiasFiltrado">7</strong> dias
          </div>

          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Miembro</th>
                  <th>Email</th>
                  <th>Préstamos</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody id="tablaBeneficios">
                <!-- Filas cargadas desde la base de datos -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Asignar Beneficio -->
  <div class="modal fade" id="modalAsignarBeneficio" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-gradient">
          <h5 class="modal-title text-dark">Asignar Beneficio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-success">
            <strong>Miembro:</strong> Ana Martínez<br>
            <strong>Préstamos este mes:</strong> 6
          </div>
          <form id="formAsignarBeneficio">
            <div class="mb-3">
              <label class="form-label">Tipo de Beneficio</label>
              <select class="form-select" id="tipoBeneficio" required>
                <option value="">Seleccionar beneficio...</option>
                <option value="descuento">Descuento en multas (50%)</option>
                <option value="extension">Extensión de préstamo (+7 días)</option>
                <option value="prioridad">Prioridad en reservas</option>
                <option value="gratuito">Préstamo extra gratuito</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Mensaje de Notificación</label>
              <textarea class="form-control" rows="5" id="mensajeBeneficio" required>¡Felicidades Ana Martínez!

Has sido seleccionado/a para recibir un beneficio especial por tu excelente participación en nuestra biblioteca.

Este mes has realizado 6 préstamos, demostrando tu amor por la lectura.

Como reconocimiento, te hemos asignado un beneficio especial.

¡Gracias por ser parte de nuestra comunidad de lectores!</textarea>
            </div>
            <!-- NUEVAS CASILLAS DE CHECK EN LÍNEA -->
<div class="mb-3">
  <label class="form-label">Enviar Notificación vía:</label>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" value="email" id="checkEmail" checked>
    <label class="form-check-label" for="checkEmail">Email</label>
  </div>
  <div class="form-check form-check-inline">
    <input class="form-check-input" type="checkbox" value="whatsapp" id="checkWhatsapp">
    <label class="form-check-label" for="checkWhatsapp">WhatsApp</label>
  </div>
</div>

            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-send me-2"></i>Asignar y Notificar
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast para notificaciones -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11000">
    <div id="toastMensaje" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastTexto">
          Mensaje del sistema
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../JS/sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../JS/prestamos.js"></script>
</body>
</html>
